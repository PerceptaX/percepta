---
phase: 2.5-multi-led-identity
plan: 01
type: execute
---

<objective>
Fix parser to assign deterministic LED names by index, establishing stable signal identity.

Purpose: Enable diff to compare behavior across firmware versions. Without stable signal identity (LED1 today == LED1 tomorrow), diff is meaningless and firmware regression detection collapses.

Output: Parser that consistently produces LED1, LED2, LED3 across multiple observe runs, enabling reliable behavioral comparison.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-vision/01-02-SUMMARY.md
@internal/vision/parser.go
@internal/core/types.go

**Current problem:**
Parser uses `FindAllStringSubmatch` correctly but assigns name "UNKNOWN" when match[1] is empty. This causes:
- Different LED on each observe run
- Unstable signal identity
- Diff cannot compare (LED2 today != LED2 tomorrow)
- Assertions unpredictable

**Tech stack available:**
- Go 1.25
- Claude Vision API (Sonnet 4.5)
- Regex-based parser (internal/vision/parser.go)

**Constraining decisions:**
- Parser isolated behind SignalParser interface (enables future swap)
- Regex for MVP signal parsing (structured output later)
- Platform-agnostic architecture

**What this enables:**
Phase 3 diff requires: `[]Signal` with stable identity. Without this fix, diff compares garbage.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Assign deterministic LED names by index</name>
  <files>internal/vision/parser.go</files>
  <action>
In the LED parsing loop (line 26-69), replace the name assignment logic:

**Current (WRONG):**
```go
name := match[1]
if name == "" {
    name = "UNKNOWN"
}
```

**New (CORRECT):**
```go
// Assign deterministic name by index
name := fmt.Sprintf("LED%d", len(signals)+1)
```

This gives each LED a stable index-based identity: LED1, LED2, LED3.

**Why this works:**
- Appearance order is stable (Claude Vision sees LEDs top-to-bottom, left-to-right)
- Index-based naming is deterministic
- No spatial tracking needed yet (MVP solution)
- Enables diff to compare same LED across runs

**Do NOT:**
- Parse the name from Claude's output (unreliable)
- Use "UNKNOWN" (breaks identity)
- Attempt spatial clustering (out of scope for MVP)

**Keep:**
- All existing color extraction logic
- All existing blink rate parsing
- All existing on/off state detection
  </action>
  <verify>go build ./internal/vision succeeds</verify>
  <done>LED names assigned as LED1, LED2, LED3... by index, no "UNKNOWN" names</done>
</task>

<task type="auto">
  <name>Task 2: Verify stable identity across multiple runs</name>
  <files>None (verification only)</files>
  <action>
Run observe command twice on same device and verify:

1. Same LED count across runs
2. Same LED ordering (LED1, LED2, LED3)
3. Same logical states (blink/solid)

**Expected output:**
```
Run 1:
LED1: [state]
LED2: [state]
LED3: [state]

Run 2:
LED1: [state]  ← Same LED
LED2: [state]  ← Same LED
LED3: [state]  ← Same LED
```

Color may vary slightly (OCR noise), but LED identity must be stable.

If LED count changes or ordering shuffles, identity is NOT stable - investigate why.
  </action>
  <verify>
Run: ./percepta observe fpga
Run again: ./percepta observe fpga
Compare output - same LED count and names
  </verify>
  <done>Two consecutive observe runs produce same LED count and same LED names (LED1, LED2, LED3)</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go build ./...` succeeds without errors
- [ ] Parser assigns LED1, LED2, LED3 (not "UNKNOWN")
- [ ] Two consecutive observe runs show same LED count
- [ ] Two consecutive observe runs show same LED names
- [ ] Object permanence achieved: LED1 today == LED1 tomorrow
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors
- LED identity stable across multiple observe runs
- **Phase 2.5 complete**: Ready for Phase 3 diff (stable signal identity established)
  </success_criteria>

<output>
After completion, create `.planning/phases/2.5-multi-led-identity/2.5-01-SUMMARY.md`:

# Phase 2.5 Plan 1: Multi-LED Identity Summary

**Index-based LED naming establishes object permanence for perception kernel**

## Accomplishments

- LED names assigned by index (LED1, LED2, LED3)
- Stable signal identity across multiple observe runs
- Object permanence achieved: LED1 today == LED1 tomorrow
- Phase 3 diff unblocked (requires stable signal identity)

## Files Created/Modified

- `internal/vision/parser.go` - Changed name assignment from "UNKNOWN" to index-based

## Decisions Made

[Key decisions and rationale, or "None - followed plan"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 2.5 complete! Ready for Phase 3: Diff + Firmware Tracking.**

Phase 2.5 delivered stable signal identity. Diff can now compare:
- LED1 across firmware versions
- LED2 behavior before/after changes
- LED3 regression detection

Success criteria: Perception kernel has object permanence. Ready for behavioral comparison.
</output>
