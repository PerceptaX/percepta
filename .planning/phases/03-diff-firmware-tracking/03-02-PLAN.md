---
phase: 03-diff-firmware-tracking
plan: 02
subsystem: cli
scope: small
estimated_tasks: 3
checkpoint_type: none
execution_mode: autonomous
requires:
  - phase: 03-01
    provides: [sqlite-storage, firmware-hash-tracking, git-integration]
  - phase: 2.5-01
    provides: [stable-signal-identity]
provides:
  - Observation comparison logic
  - Diff command with --from/--to flags
  - Human-readable diff output
  - Signal-level change detection
  - Phase 3 complete
affects: []
tech-stack:
  added: []
  patterns: [signal-diffing, set-comparison, human-readable-output]
---

# Phase 3 Plan 2: Observation Comparison and Diff Command

## Objective

**Implement `percepta diff` command to compare hardware behavior across firmware versions.**

This plan adds the diff capability - the core value of Phase 3. Users can compare observations from two firmware commits to detect behavioral changes (new LEDs, changed blink rates, different display text).

## Execution Context

**Files to read:**
- @internal/core/types.go - Signal types (LEDSignal, DisplaySignal, BootTimingSignal)
- @internal/storage/sqlite.go - QueryByFirmware() for fetching observations
- @cmd/percepta/observe.go - Output formatting patterns to reuse
- @.planning/phases/2.5-multi-led-identity/2.5-01-SUMMARY.md - Object permanence context

**Dependencies:**
- Phase 03-01: SQLite storage with firmware hash tracking
- Phase 2.5: Stable signal identity (LED1 = LED1 across observations)

**Tech stack additions:**
- None (stdlib only)

## Context

**Current state:**
- Observations stored in SQLite with firmware_hash
- Stable signal identity (LED1, LED2, LED3)
- No diff capability

**Target state:**
- `percepta diff fpga --from abc123 --to def456` compares observations
- Detects added/removed/changed signals
- Human-readable output showing differences
- Exit code 0 if identical, 1 if differences found

**Key insight from Phase 2.5:**
- ISS-001: Single-frame capture may miss blinking LEDs
- Diff compares whatever signals ARE captured
- Object permanence (LED1 = LED1) enables meaningful comparison

**Acceptance criteria:**
1. `percepta diff fpga --from <hash> --to <hash>` compares firmware versions
2. Detects added signals (LED2 appears in new firmware)
3. Detects removed signals (LED1 missing in new firmware)
4. Detects changed signals (LED1 color changed, blink rate changed)
5. Human-readable output with +/- indicators
6. Exit code 0 for identical, 1 for differences

## Tasks

### Task 1: Implement signal comparison logic

**Objective:** Create diff engine that compares two observations signal-by-signal.

**Files to create:**
- `internal/diff/compare.go`
- `internal/diff/types.go`

**Implementation:**
1. Define diff types:
   ```go
   type SignalDiff struct {
       Name     string
       Type     string // "led", "display", "boot_timing"
       Change   ChangeType // Added, Removed, Modified, Unchanged
       Before   core.Signal
       After    core.Signal
   }

   type ChangeType int
   const (
       Added ChangeType = iota
       Removed
       Modified
       Unchanged
   )

   type ObservationDiff struct {
       DeviceID     string
       FromHash     string
       ToHash       string
       SignalDiffs  []SignalDiff
       HasChanges   bool
   }
   ```

2. Implement CompareObservations(from, to *core.Observation) *ObservationDiff:
   - Build signal maps by name (LED1 → LEDSignal)
   - Detect added: signals in 'to' but not in 'from'
   - Detect removed: signals in 'from' but not in 'to'
   - Detect modified: signals in both with different states
   - Use signal-specific comparison (LED color/blink, Display text)

3. LED comparison logic:
   - Compare On state
   - Compare Color (RGB within ±5 tolerance from Phase 2)
   - Compare BlinkHz (within 10% tolerance from Phase 2)
   - Modified if any field differs beyond tolerance

4. Display comparison logic:
   - Compare Text (contains() for OCR noise tolerance)
   - Modified if text substantially different

**Success criteria:**
- CompareObservations() detects all change types
- Tolerances match assertion engine (Phase 2)
- Signal identity (LED1 vs LED2) drives comparison

### Task 2: Add storage query methods for firmware ranges

**Objective:** Enable querying observations by firmware hash for diff.

**Files to modify:**
- `internal/storage/sqlite.go` - add QueryByFirmware()

**Implementation:**
1. Add method:
   ```go
   func (s *SQLiteStorage) QueryByFirmware(deviceID, firmwareHash string, limit int) ([]core.Observation, error) {
       query := `SELECT id, device_id, firmware_hash, timestamp, signals_json
                 FROM observations
                 WHERE device_id = ? AND firmware_hash = ?
                 ORDER BY timestamp DESC
                 LIMIT ?`
       // Execute and deserialize
   }
   ```

2. Add method to get latest observation for a firmware hash:
   ```go
   func (s *SQLiteStorage) GetLatestForFirmware(deviceID, firmwareHash string) (*core.Observation, error) {
       obs, err := s.QueryByFirmware(deviceID, firmwareHash, 1)
       if err != nil || len(obs) == 0 {
           return nil, fmt.Errorf("no observations found for firmware %s", firmwareHash)
       }
       return &obs[0], nil
   }
   ```

**Success criteria:**
- QueryByFirmware() returns observations for specific hash
- GetLatestForFirmware() returns most recent observation
- Handles missing firmware hashes gracefully

### Task 3: Implement diff CLI command

**Objective:** Create `percepta diff` command with --from/--to flags and human-readable output.

**Files to create:**
- `cmd/percepta/diff.go`

**Files to modify:**
- `cmd/percepta/main.go` - register diff command

**Implementation:**
1. Command structure:
   ```go
   var diffCmd = &cobra.Command{
       Use:   "diff DEVICE",
       Short: "Compare hardware behavior across firmware versions",
       Long:  "Compare observations from two firmware commits to detect behavioral changes",
       Args:  cobra.ExactArgs(1),
       RunE:  runDiff,
   }

   func init() {
       diffCmd.Flags().String("from", "", "Source firmware commit hash (required)")
       diffCmd.Flags().String("to", "", "Target firmware commit hash (required)")
       diffCmd.MarkFlagRequired("from")
       diffCmd.MarkFlagRequired("to")
   }
   ```

2. Implement runDiff():
   - Load storage (SQLite)
   - Query observations for --from and --to hashes
   - Call diff.CompareObservations()
   - Format and print diff
   - Return exit code (0 if no changes, 1 if changes)

3. Output format (reuse observe command patterns):
   ```
   Comparing firmware versions:
   FROM: abc123def (2026-02-11 10:30:00)
   TO:   def456abc (2026-02-11 11:45:00)

   Device: fpga

   Changes detected:

   + LED2: purple blinking ~0.8Hz (ADDED)
   - LED3: red solid (REMOVED)
   ~ LED1: blue blinking ~2.0Hz → ~2.5Hz (MODIFIED)

   Summary: 1 added, 1 removed, 1 modified
   ```

4. Exit codes:
   - 0 if no changes (identical behavior)
   - 1 if changes detected
   - 2 if error (missing firmware hash, no observations)

**Success criteria:**
- `percepta diff fpga --from X --to Y` works end-to-end
- Detects all change types (added, removed, modified)
- Human-readable output with +/~/- indicators
- Correct exit codes for CI/automation

## Verification

**Manual testing:**
```bash
# Setup: capture observations for two firmware versions
cd /path/to/firmware
git checkout old-version
./percepta observe fpga  # Captured with hash abc123

git checkout new-version
./percepta observe fpga  # Captured with hash def456

# Test diff
./percepta diff fpga --from abc123 --to def456
# Should show differences (added/removed/modified LEDs)

# Test identical case
./percepta observe fpga  # Second observation on same firmware
./percepta diff fpga --from def456 --to def456
# Should show "No changes detected"
# Exit code should be 0

# Test exit codes
./percepta diff fpga --from abc123 --to def456 && echo "NO CHANGES" || echo "CHANGES DETECTED"
# Should print "CHANGES DETECTED"

# Test missing firmware hash
./percepta diff fpga --from nonexistent --to def456
# Should error gracefully
```

**Automated testing:**
- Create two observations with different signals
- Run diff, verify correct change detection
- Verify exit codes

## Success Criteria

- [ ] Signal comparison logic implemented with tolerances
- [ ] QueryByFirmware() added to SQLite storage
- [ ] Diff CLI command with --from/--to flags
- [ ] Human-readable output with +/-/~ indicators
- [ ] Exit code 0 for no changes, 1 for changes detected
- [ ] Handles missing firmware hashes gracefully
- [ ] Works with stable signal identity from Phase 2.5
- [ ] Phase 3 complete: observe + assert + diff all working

## Output

**Deliverables:**
1. `internal/diff/compare.go` - Observation comparison logic
2. `internal/diff/types.go` - Diff type definitions
3. `cmd/percepta/diff.go` - Diff CLI command
4. Modified SQLite storage with QueryByFirmware()
5. Human-readable diff output format

**Verification artifacts:**
- Manual test results showing diff detection
- Exit code validation
- Example diff output

**Phase 3 complete!** All three verbs (observe, assert, diff) now operational. Ready for Phase 4: Polish + Alpha.

## Notes

**Handles ISS-001 gracefully:**
- Single-frame capture means diff compares captured signals only
- If LED2 missing in 'from' (OFF during capture), won't show as "removed"
- Object permanence (LED1 = LED1) enables consistent comparison
- This is acceptable for MVP - multi-frame capture can improve later
