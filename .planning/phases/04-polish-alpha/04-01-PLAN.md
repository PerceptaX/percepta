---
phase: 04-polish-alpha
plan: 01
type: execute
---

<objective>
Add device management CLI commands for streamlined alpha user onboarding.

Purpose: Enable users to configure devices without manually editing YAML files. Device management commands reduce friction during first-time setup and make firmware tag updates explicit and discoverable.

Output: Working `device list`, `device add`, `device set-firmware` commands with validation and helpful error messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Tech stack available:**
- Go with Cobra/Viper for CLI
- SQLite storage (modernc.org/sqlite)
- Config at ~/.config/percepta/config.yaml

**Established patterns:**
- Commands in cmd/percepta/{command}.go
- Config management in internal/config/config.go
- Register commands in cmd/percepta/main.go init()

**Constraining decisions:**
- Phase 1: Config file optional with defaults (must maintain)
- Phase 3: Manual firmware tagging (device set-firmware updates config)
- Manual camera config (no auto-detection wizard)

**Current config structure:**
```yaml
vision:
  provider: claude
devices:
  fpga:
    type: fpga
    camera_id: /dev/video0
    firmware: v1
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add device list command</name>
  <files>cmd/percepta/device.go</files>
  <action>Create `device list` command that reads config and displays all configured devices with their camera_id and firmware tags. Format:

```
Configured devices:

fpga
  Type: fpga
  Camera: /dev/video0
  Firmware: v1

esp32
  Type: esp32
  Camera: /dev/video2
  Firmware: main
```

If no devices configured, show helpful message: "No devices configured. Add one with: percepta device add <name>"

Use existing config.Load() from internal/config/config.go. Register command as subcommand of device parent command.</action>
  <verify>./percepta device list shows configured devices, returns appropriate message if none exist</verify>
  <done>Command shows all devices with formatting, handles empty config gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Add device add command with interactive prompts</name>
  <files>cmd/percepta/device.go, internal/config/config.go</files>
  <action>Create `device add <name>` command that interactively prompts for device configuration:
1. Prompt: "Device type (e.g., fpga, esp32, stm32):" → store in config.Type
2. Prompt: "Camera device path (default: /dev/video0):" → store in config.CameraID
3. Prompt: "Firmware version (optional, press Enter to skip):" → store in config.Firmware (empty string if skipped)

Write updated config back to ~/.config/percepta/config.yaml using Viper. Create parent directory if doesn't exist. If device name already exists, show error: "Device 'X' already exists. Use 'percepta device list' to see all devices."

Use bufio.NewScanner(os.Stdin) for reading input. Handle Ctrl+C gracefully.</action>
  <verify>./percepta device add testdev prompts for inputs, saves to config, ./percepta device list shows new device</verify>
  <done>Command adds device to config interactively, validates device doesn't exist, writes valid YAML</done>
</task>

<task type="auto">
  <name>Task 3: Add device set-firmware command</name>
  <files>cmd/percepta/device.go</files>
  <action>Create `device set-firmware <device> <firmware>` command that updates firmware tag for existing device. Load config, check device exists (error if not: "Device 'X' not found. Use 'percepta device list' to see all devices."), update Device.Firmware field, write config back. Show confirmation: "Updated firmware for 'X': v1 → v2" (or "Set firmware for 'X': v2" if previously empty).

This command is the primary way users update firmware tags for diff workflow.</action>
  <verify>./percepta device set-firmware fpga v2 updates config, ./percepta device list shows updated firmware</verify>
  <done>Command updates firmware tag, validates device exists, shows confirmation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cmd/percepta` succeeds without errors
- [ ] `./percepta device list` works with empty config and populated config
- [ ] `./percepta device add` creates valid YAML, handles existing devices
- [ ] `./percepta device set-firmware` updates existing device firmware
- [ ] All commands show helpful error messages for common mistakes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Device management commands are discoverable (`percepta --help` shows device command)
- Error messages are helpful and actionable
- Config file is created with proper permissions (0644)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-polish-alpha/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Device Management CLI Summary

**Device management commands enable configuration without manual YAML editing.**

## Accomplishments

- device list: Shows all configured devices
- device add: Interactive device configuration
- device set-firmware: Updates firmware tags
- Helpful error messages and validation

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Step

Ready for 04-02-PLAN.md (Documentation + Alpha Release)
</output>
